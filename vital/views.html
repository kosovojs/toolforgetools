<!DOCTYPE html>
<html>
<head>
<title>Pēc valodas</title>
<meta charset="utf-8" />
<script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://tools-static.wmflabs.org/cdnjs/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://tools-static.wmflabs.org/cdnjs/ajax/libs/selectize.js/0.12.4/js/standalone/selectize.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://tools-static.wmflabs.org/cdnjs/ajax/libs/selectize.js/0.12.4/css/selectize.bootstrap3.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
<script src="common.js"></script>
</head>
<body>
<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://localhost/vital/">Vital</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="group.html">Pēc grupas</a></li>
        <li class="active"><a href="views.html">Pēc skatījumiem</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<div class="container">
<div class="row">
	<div class="col-md-2 col-sm-2 col-xs-2">
    <label>Izvēlies valodu </label>
	</div>
	<div class="col-md-8 col-sm-8 col-xs-8">
    <span id="select1"></span>
	</div>
</div>
<span id="last_upd"></span>
<br>
<br>

		<table class="table table-striped" id="mainTable">
			<thead>
				<tr>
					<th>Raksts</th>
					<th>Mean</th>
					<th>Mean new</th>
					<th>Sum</th>
					<th>Sum new</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
</div>
<script>
var table;
function add_table(data1) {
	table = $('#mainTable').DataTable({
		"lengthMenu": [[25, 50,-1], [25, 50, "All"]],
		"aaData": data1,
		"aoColumns": [
			{
				"mDataProp": null
			},
			{
				"mDataProp": null,
				"sDefaultContent": "",
				"orderSequence": ["desc", "asc"]
			},
			{
				"mDataProp": null,
				"sClass": "right",
				"orderSequence": ["desc", "asc"]
			},
			{
				"mDataProp": null,
				"orderSequence": ["desc", "asc"]
			},
			{
				"mDataProp": null,
				"sClass": "right",
				"orderSequence": ["desc", "asc"]
			}
	],
		"columnDefs": [{
				"render": function(data) {
					return create_wp_link('en',data[0],data[0]);
				},
				"targets": 0
			}, {
				"render": function(data) {
					return parseFloat(data[1]).toFixed(3);
				},
				"targets": 1
			}, {
				"render": function(data) {
					return parseFloat(data[2]).toFixed(3);
				},
				"targets": 2
			}, {
				"render": function(data) {
					return parseFloat(data[3]).toFixed(3);
				},
				"targets": 3
			}, {
				"render": function(data) {
					return parseFloat(data[4]).toFixed(3);
				},
				"targets": 4
			}],
		"order": [[2, "desc"]]
	});

}


function replaceAll(str, find, replace) {
    if (str && str != null) {
		return str.replace(new RegExp(find, 'g'), replace);
	} else {
		return str;
	}
}

Array.prototype.unique = function() {
  return this.filter(function (value, index, self) { 
    return self.indexOf(value) === index;
  });
}

function push_to_arr(arr,key,val) {
	if (key in arr) {
		arr[key].push(val);
	} else {
		arr[key] = [val];
	}
	
	return arr
}

function get_unique_key_values(data1) {
	var keys = [];

	for (i = 0; i < data1.length; i++) {
		var infs = data1[i][2];
		
		for (z = 0; z < infs.length; z++) {
			if (!(infs[z] in keys)) {
				keys.push(infs[z]);
			}
		}
	}
	
	keys = keys.unique().sort(compare);//a.toLowerCase()-b.toLowerCase()});//fix sorting
	
	//console.log(keys);
	
	return keys
}


function sort_by_key(data1) {
	keys = Object.keys(data1);
	//get_unique_key_values(data1);
	var arr1 = {};
	
	for (i = 0; i < data1.length; i++) {
		var infs = data1[i][2];
		
		for (z = 0; z < infs.length; z++) {
			push_to_arr(arr1,infs[z],[data1[i][0],data1[i][1]]);
			
			//arr1[infs[z]].push([data1[i][0],data1[i][1]]);
		}
	}
	console.log(arr1);
	
	return arr1
}

function create_select(select_data) {
	var aaa = [];
	//select_data = select_data.sort(compare);
	aaa.push('<select id="myselect">');
	aaa.push('<option value=""></option>');
	for (i = 0; i < select_data.length; i++) {
		if (select_data[i]=='') {
			aaa.push('<option value="'+select_data[i]+'">Nav infokastes</option>');
		} else {
			aaa.push('<option value="'+select_data[i]+'">'+replaceAll(select_data[i],'_',' ')+'</option>');
		}
	}
	aaa.push('</select>');
	
	return aaa.join('');
}

function main(data_for_table,langwiki) {
	var aaa = [];
	console.log('main function');
	console.log(data_for_table.length);
	//console.log(data1);
	
	if (data_for_table.length>20)
		aaa.push('<div style="-moz-column-count:3; -webkit-column-count:3; column-count:3;">');
	aaa.push('<ul>');
	
	for (y = 0; y < data_for_table.length; y++) {
		if (y==2500) {break;}
		aaa.push('<li>'+create_wp_link(langwiki,data_for_table[y][0],data_for_table[y][0])+' - '+data_for_table[y][1]+'</li>');
	}
	aaa.push('</ul>');
	if (data_for_table.length>20)
		aaa.push('</div>');
	
	return aaa.join('')+'';
}

function create_link(site,href,label) {
	if (site=='d') {
		return '<a href="https://www.wikidata.org/wiki/'+href+'">'+label+'</a>'
	} else if (site=='sr') {
		return '<a href="http://www.sports-reference.com/olympics/athletes/'+href+'.html">'+label+' <small>('+href+')</small></a>'
	}
}

function create_wp_link(lang,href,label) {
	return '<a target="_blank" href="https://'+lang+'.wikipedia.org/wiki/'+href+'">'+replaceAll(label, '_', ' ')+'</a>'
}


function get_all_infoboxes() {
	$.ajax({
		type: "GET",
		url: 'api.php',                  //the script to call to get data          
		//contentType: "application/json; charset=utf-8",
		data: {'act':'all_views'},                        //you can insert url argumnets here to pass to api.php
		dataType: 'JSON'                //data format      
		})
		.done(function(data1) {          //on recieve of reply
			console.log('fsfdffsd');
			console.log(data1);
			//datt = JSON.parse(data1);
			$('#select1').html(create_select(data1));
			
			
				$('#myselect').selectize({
					persist: false,
					createOnBlur: true,
					create: false
	});
			
			
			
		})
}

function get_data(what_selected,redraw) {
	console.log('selected: '+what_selected);
	$.ajax({
		type: "GET",
		url: 'api.php',                  //the script to call to get data          
		data: {'act':'get_views','val':what_selected},                        //you can insert url argumnets here to pass to api.php
		dataType: 'json'                //data format  
		//async: false		
		})
		.done(function(data1) {          //on recieve of reply
			console.log('tgrfgfrddddddddddddf');
			console.log(data1);
			console.log(data1['data']);
			$('#last_upd').html('Dati pēdējoreiz atjaunināti: '+data1['update']);
			//datt = JSON.parse(data1['data']);
			
			
			if (table) {
				table.clear().draw();
				table.rows.add(data1['data']); // Add new data
				table.columns.adjust().draw(); // Redraw the DataTable
			} else {
				add_table(data1['data']);
			}
			
			//$('#fdfsdfoobarlorem12312dsfdf12').html(gfgfdgfgdf);
			
			//return gfgfdgfgdf;
		})
		
}

//console.log(bigone);

$(document).ready(function () {
	
	//$('#select1').html(create_select(Object.keys(data)));
	get_all_infoboxes();
	
	
	
		$( "#select1 option:selected" ).each(function() {
			console.log($(this).attr('value'));
			
			if ($(this).attr('value') != '')
				get_data($(this).attr('value'));
			
			//$('#fdfsdfoobarlorem12312dsfdf12').html(resdata);
			
		});
	
	$('#select1').on('change', function() {
		//console.log( this.value );
		$( "#select1 option:selected" ).each(function() {
			console.log($(this).attr('value'));
			$('#fdfsdfoobarlorem12312dsfdf12').html('');
			
			
			
			get_data($(this).attr('value'),true);
			
			//$('#fdfsdfoobarlorem12312dsfdf12').html(resdata);
			
		});
	});
});

</script>
</body>
</html>